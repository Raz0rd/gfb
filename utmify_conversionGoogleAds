# Sistema de Rastreamento: Utmify + Google Ads

## ğŸ“‹ VisÃ£o Geral

Este documento explica como funciona o sistema de rastreamento de vendas, incluindo:
- Envio de dados para o **Utmify** (rastreamento de conversÃµes e comissÃµes)
- Disparo de conversÃµes para o **Google Ads** (otimizaÃ§Ã£o de campanhas)

---

## ğŸ”„ Fluxo Completo de uma Venda

### 1ï¸âƒ£ **Cliente Cria um Pedido PIX**

**Arquivo:** `Backend/api/server.js` (linha 537-808)  
**Endpoint:** `POST /api/payment/pix`

**O que acontece:**

1. Cliente preenche o formulÃ¡rio de checkout com:
   - Nome completo
   - CPF
   - Email
   - Telefone
   - Produto selecionado

2. Backend cria uma transaÃ§Ã£o PIX na **Umbrela** (gateway de pagamento)

3. **Primeiro envio para Utmify** com status `waiting_payment`:
   ```javascript
   // Linhas 742-762
   await sendUtmify({
     orderId: String(txId),
     platform: 'RecargaGames',
     paymentMethod: 'pix',
     status: 'waiting_payment',  // âš ï¸ VENDA PENDENTE
     dates: { createdAt: createdAtUTC },
     customer: { name, email, phone, document, ip },
     products: [...],
     tracking: { utm_source, utm_campaign, ... },
     commission: { totalPriceInCents, gatewayFeeInCents, ... }
   });
   ```

4. Sistema salva os dados da transaÃ§Ã£o em memÃ³ria (`ordersStore`)

5. Email automÃ¡tico Ã© enviado ao cliente com o cÃ³digo PIX

**Status no Utmify:** `waiting_payment` (venda pendente)

---

### 2ï¸âƒ£ **Cliente Paga o PIX**

Existem **2 formas** de detectar o pagamento:

#### **Forma A: Webhook da Umbrela** (Recomendado)

**Arquivo:** `Backend/api/server.js` (linha 913-989)  
**Endpoint:** `POST /webhooks/umbrela`

A Umbrela envia automaticamente uma notificaÃ§Ã£o quando o pagamento Ã© confirmado.

**O que acontece:**

1. Umbrela detecta o pagamento e envia webhook para o servidor

2. Backend mapeia o status:
   ```javascript
   // Linhas 922-928
   if (rawStatus === 'PAID') utmStatus = 'paid';
   ```

3. **Segundo envio para Utmify** com status `paid`:
   ```javascript
   // Linhas 946-956
   await sendUtmify({
     orderId: String(txId),
     status: 'paid',  // âœ… VENDA PAGA
     dates: { 
       createdAt: createdAtUTC, 
       approvedDate: approvedDateUTC  // Data/hora do pagamento
     },
     customer: { ... },
     products: [ ... ],
     tracking: { ... },
     commission: { ... }
   });
   ```

4. Email de confirmaÃ§Ã£o Ã© enviado ao cliente

5. Email de "processamento" Ã© agendado para 30 minutos depois (caso haja atraso na entrega)

**Status no Utmify:** `paid` (venda confirmada)

---

#### **Forma B: Polling do Frontend** (Backup)

**Arquivo:** `Frontend/js/checkout.js` (linha 221-249)

O frontend consulta o status a cada 4 segundos:

```javascript
// Linha 226-248
statusInterval = setInterval(async () => {
  const r = await fetch(`/api/payment/status/${txId}`);
  const j = await r.json();
  
  if (j.paid === true) {
    stopStatusPolling();
    sendGoogleConversion();  // ğŸ¯ DISPARA CONVERSÃƒO GOOGLE ADS
    showSuccess();
  }
}, 4000);
```

**Arquivo:** `Backend/api/server.js` (linha 810-911)  
**Endpoint:** `GET /api/payment/status/:id`

Quando o frontend detecta `paid: true`, ele:
1. Para o polling
2. **Dispara a conversÃ£o do Google Ads** (ver prÃ³xima seÃ§Ã£o)
3. Mostra tela de sucesso

O backend tambÃ©m envia para o Utmify caso ainda nÃ£o tenha sido enviado (linhas 854-906).

---

### 3ï¸âƒ£ **ConversÃ£o do Google Ads**

**Arquivo:** `Frontend/js/checkout.js` (linha 256-287)

**Quando Ã© disparada:**
- Apenas quando o status muda para `paid` (pagamento confirmado)
- Apenas uma vez por transaÃ§Ã£o (controle via flag `conversionSent`)

**Como funciona:**

```javascript
function sendGoogleConversion() {
  // Verifica se jÃ¡ foi enviada
  if (conversionSent) return;
  
  // Verifica se gtag estÃ¡ disponÃ­vel
  if (typeof gtag === 'undefined') {
    // Aguarda 2 segundos e tenta novamente
    setTimeout(() => sendGoogleConversion(), 2000);
    return;
  }
  
  // Envia conversÃ£o para o Google Ads
  gtag('event', 'conversion', {
    'send_to': 'AW-17655865530/KkrgCNSwh64bELrB_OJB',  // ID da conversÃ£o
    'value': currentTransactionValue,  // Valor da venda
    'currency': 'BRL',
    'transaction_id': currentTxId  // ID Ãºnico da transaÃ§Ã£o
  });
  
  conversionSent = true;
  console.log('âœ… ConversÃ£o Google Ads enviada:', currentTxId, currentTransactionValue);
}
```

**Dados enviados:**
- **send_to:** ID da conversÃ£o do Google Ads
- **value:** Valor total da venda (com desconto aplicado)
- **currency:** BRL (Real Brasileiro)
- **transaction_id:** ID da transaÃ§Ã£o na Umbrela (evita duplicatas)

---

## ğŸ“Š Resumo dos Status no Utmify

| Status | Quando Ã© enviado | DescriÃ§Ã£o |
|--------|------------------|-----------|
| `waiting_payment` | Ao criar o PIX | Venda pendente, aguardando pagamento |
| `paid` | Quando o pagamento Ã© confirmado | Venda paga e confirmada |
| `refused` | Quando o pagamento Ã© recusado | Venda recusada |
| `refunded` | Quando hÃ¡ estorno | Venda estornada |
| `chargedback` | Quando hÃ¡ chargeback | ContestaÃ§Ã£o de pagamento |

---

## ğŸ” ProteÃ§Ã£o Contra Duplicatas

O sistema possui **3 camadas de proteÃ§Ã£o** contra envios duplicados:

### 1. Controle de Status Processados

```javascript
// Linhas 89-111
const processedStatus = new Map();

function wasStatusProcessed(txId, status) {
  const key = `${txId}:${status}`;
  return processedStatus.has(key);
}

function markStatusProcessed(txId, status) {
  const key = `${txId}:${status}`;
  processedStatus.set(key, Date.now());
  // Limpa apÃ³s 24h para nÃ£o acumular memÃ³ria
  setTimeout(() => processedStatus.delete(key), 24 * 60 * 60 * 1000);
}
```

### 2. VerificaÃ§Ã£o Antes de Enviar

```javascript
// Exemplo: linha 742
if (!wasStatusProcessed(String(txId), 'waiting_payment')) {
  await sendUtmify({ ... });
  markStatusProcessed(String(txId), 'waiting_payment');
}
```

### 3. Transaction ID no Google Ads

O Google Ads usa o `transaction_id` para identificar conversÃµes Ãºnicas e ignorar duplicatas automaticamente.

---

## ğŸ“§ Sistema de Emails

### Email 1: PIX Criado
- **Quando:** Imediatamente apÃ³s criar o PIX
- **ConteÃºdo:** CÃ³digo PIX para pagamento
- **FunÃ§Ã£o:** `sendPixCreatedEmail()` (linha 120-199)

### Email 2: Pagamento Confirmado
- **Quando:** Quando status muda para `paid`
- **ConteÃºdo:** ConfirmaÃ§Ã£o de pagamento aprovado
- **FunÃ§Ã£o:** `sendPaymentConfirmedEmail()` (linha 201-279)

### Email 3: Processamento Atrasado
- **Quando:** 30 minutos apÃ³s o pagamento (se ainda nÃ£o entregue)
- **ConteÃºdo:** Aviso de instabilidade temporÃ¡ria
- **FunÃ§Ã£o:** `sendProcessingDelayEmail()` (linha 281-363)
- **Agendamento:** `scheduleDelayedEmail()` (linha 368-384)

---

## ğŸ¯ ParÃ¢metros UTM Rastreados

O sistema captura e envia para o Utmify os seguintes parÃ¢metros:

```javascript
// Linhas 395-407
{
  src: utm_source ou src,
  sck: gclid ou gbraid ou wbraid ou sck,
  utm_source: 'google',
  utm_medium: 'cpc',
  utm_campaign: 'nome_da_campanha',
  utm_content: 'anuncio_1',
  utm_term: 'palavra_chave'
}
```

**Como sÃ£o capturados:**
1. Frontend envia via `POST /track-utm` (linha 409-422)
2. Backend salva em cookie `utm_tracking`
3. Cookie Ã© lido ao criar a transaÃ§Ã£o PIX

---

## ğŸ”§ ConfiguraÃ§Ã£o NecessÃ¡ria

### VariÃ¡veis de Ambiente (.env)

```bash
# Umbrela (Gateway de Pagamento)
UMBRELA_BASE_URL=https://api-gateway.umbrellapag.com/api
UMBRELA_API_KEY=sua_chave_api
UMBRELA_USER_AGENT=UMBRELLAB2B/1.0
UMBRELA_POSTBACK_URL=https://seu-dominio.com/webhooks/umbrela
PIX_EXPIRES_DAYS=1

# Utmify (Rastreamento)
UTMIFY_TOKEN=seu_token_utmify

# Email (Resend)
RESEND_API_KEY=sua_chave_resend
EMAIL_FROM=noreply@digitrongames.com.br
LOGO_URL=https://i.imgur.com/placeholder.png

# Servidor
PORT=3000
SAME_ORIGIN_DEV=true
```

### Google Ads (Frontend)

No arquivo HTML, adicione o script do Google Ads:

```html
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17655865530"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'AW-17655865530');
</script>
```

---

## ğŸ“ˆ Dados Enviados para o Utmify

### Estrutura Completa

```javascript
{
  orderId: "12345",                    // ID da transaÃ§Ã£o
  platform: "RecargaGames",            // Nome da plataforma
  paymentMethod: "pix",                // MÃ©todo de pagamento
  status: "paid",                      // Status da venda
  
  commission: {
    totalPriceInCents: 5000,           // R$ 50,00
    gatewayFeeInCents: 250,            // R$ 2,50 (taxa do gateway)
    userCommissionInCents: 4750        // R$ 47,50 (comissÃ£o lÃ­quida)
  },
  
  createdAt: "2025-10-21 03:19:00",    // Data de criaÃ§Ã£o
  approvedDate: "2025-10-21 03:25:00", // Data de aprovaÃ§Ã£o (null se pendente)
  refundedAt: null,                    // Data de estorno (null se nÃ£o estornado)
  
  customer: {
    name: "JoÃ£o Silva",
    email: "joao@example.com",
    phone: "11999999999",
    document: "12345678900",           // CPF
    country: "BR",
    ip: "192.168.1.1"
  },
  
  products: [
    {
      id: "ff-diamonds-100",
      name: "100 Diamantes Free Fire",
      planId: null,
      planName: null,
      quantity: 1,
      priceInCents: 5000
    }
  ],
  
  trackingParameters: {
    src: "google",
    sck: "Cj0KCQiA...",                // gclid
    utm_source: "google",
    utm_campaign: "campanha_ff",
    utm_medium: "cpc",
    utm_content: "anuncio_1",
    utm_term: "diamantes+free+fire"
  },
  
  isTest: false                        // true para testes
}
```

---

## ğŸš€ Fluxo Visual Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLIENTE ACESSA O CHECKOUT                                    â”‚
â”‚    - Preenche formulÃ¡rio (nome, CPF, email, telefone)           â”‚
â”‚    - Seleciona produto                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. BACKEND CRIA TRANSAÃ‡ÃƒO PIX (Umbrela)                        â”‚
â”‚    - Gera cÃ³digo PIX                                            â”‚
â”‚    - Salva dados em memÃ³ria (ordersStore)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PRIMEIRO ENVIO PARA UTMIFY                                   â”‚
â”‚    âœ‰ï¸  Status: waiting_payment                                  â”‚
â”‚    ğŸ“Š Dados: cliente, produto, UTM, comissÃ£o                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. EMAIL 1: PIX CRIADO                                          â”‚
â”‚    ğŸ“§ Envia cÃ³digo PIX para o cliente                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. CLIENTE PAGA O PIX                                           â”‚
â”‚    ğŸ’° Pagamento confirmado no banco                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. UMBRELA ENVIA WEBHOOK                                        â”‚
â”‚    ğŸ”” POST /webhooks/umbrela                                    â”‚
â”‚    ğŸ“¨ Status: PAID                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. SEGUNDO ENVIO PARA UTMIFY                                    â”‚
â”‚    âœ‰ï¸  Status: paid                                             â”‚
â”‚    ğŸ“Š Dados: mesmos dados + approvedDate                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. EMAIL 2: PAGAMENTO CONFIRMADO                                â”‚
â”‚    ğŸ“§ Confirma pagamento aprovado                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. FRONTEND DETECTA PAGAMENTO (Polling)                        â”‚
â”‚    ğŸ”„ GET /api/payment/status/:id (a cada 4s)                   â”‚
â”‚    âœ… Resposta: { paid: true }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. CONVERSÃƒO GOOGLE ADS                                        â”‚
â”‚     ğŸ¯ gtag('event', 'conversion', { ... })                     â”‚
â”‚     ğŸ“Š Envia: valor, moeda, transaction_id                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. TELA DE SUCESSO                                             â”‚
â”‚     ğŸ‰ Cliente vÃª confirmaÃ§Ã£o de compra                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. EMAIL 3: PROCESSAMENTO (apÃ³s 30 min)                       â”‚
â”‚     â° Se ainda nÃ£o entregue, avisa sobre atraso                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ Pontos Importantes

### 1. Dois Envios para o Utmify
- **Primeiro:** `waiting_payment` (ao criar o PIX)
- **Segundo:** `paid` (quando o pagamento Ã© confirmado)

### 2. ConversÃ£o Google Ads
- Disparada **apenas no frontend**
- Apenas quando `paid: true`
- Usa `transaction_id` para evitar duplicatas

### 3. Webhook vs Polling
- **Webhook:** Forma principal (mais rÃ¡pido e confiÃ¡vel)
- **Polling:** Backup caso webhook falhe

### 4. ProteÃ§Ã£o Contra Duplicatas
- Sistema verifica se status jÃ¡ foi processado
- Usa Map em memÃ³ria com limpeza automÃ¡tica (24h)
- Google Ads ignora conversÃµes duplicadas via `transaction_id`

### 5. Rastreamento UTM
- Capturado via cookie `utm_tracking`
- Inclui gclid, gbraid, wbraid (Google Ads)
- Enviado em todos os eventos do Utmify

---

## ğŸ› Troubleshooting

### ConversÃ£o Google Ads nÃ£o estÃ¡ sendo enviada

**PossÃ­veis causas:**
1. Script do gtag nÃ£o carregou
   - SoluÃ§Ã£o: Verificar console do navegador
   
2. `conversionSent` jÃ¡ estÃ¡ true
   - SoluÃ§Ã£o: Recarregar a pÃ¡gina
   
3. `currentTransactionValue` Ã© 0 ou null
   - SoluÃ§Ã£o: Verificar se o valor estÃ¡ sendo salvo corretamente

### Utmify nÃ£o estÃ¡ recebendo dados

**PossÃ­veis causas:**
1. `UTMIFY_TOKEN` nÃ£o configurado
   - SoluÃ§Ã£o: Adicionar no arquivo `.env`
   
2. Status jÃ¡ foi processado
   - SoluÃ§Ã£o: Verificar logs do servidor
   
3. Erro na API do Utmify
   - SoluÃ§Ã£o: Verificar logs de erro

### Webhook nÃ£o estÃ¡ funcionando

**PossÃ­veis causas:**
1. URL do webhook incorreta na Umbrela
   - SoluÃ§Ã£o: Verificar `UMBRELA_POSTBACK_URL`
   
2. Servidor nÃ£o estÃ¡ acessÃ­vel publicamente
   - SoluÃ§Ã£o: Usar ngrok ou similar para testes

---

## ğŸ“ Logs Ãšteis

O sistema gera logs detalhados para debug:

```
âœ… Email de PIX enviado para cliente@example.com
âœ… ConversÃ£o Google Ads enviada: 12345 50.00
â° Email de processamento agendado para cliente@example.com em 30 minutos
âŒ Email de processamento cancelado para transaÃ§Ã£o 12345
```

---

## ğŸ”— ReferÃªncias

- **Utmify API:** https://api.utmify.com.br/api-credentials/orders
- **Google Ads Conversions:** https://support.google.com/google-ads/answer/6331314
- **Umbrela API:** https://api-gateway.umbrellapag.com/api

---

**Ãšltima atualizaÃ§Ã£o:** 21/10/2025
